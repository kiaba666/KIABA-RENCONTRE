{% extends "base.html" %}
{% block title %}{{ ad.title }} · {{ ad.city.name }} · KIABA CI{% endblock %}
{% block description %}{{ ad.title }} - {{ ad.get_category_display }} à {{ ad.city.name }}, Côte d'Ivoire. {{ ad.description_sanitized|truncatewords:25|striptags }}. Contactez directement sur KIABA, alternative à Bizi, Jedolo et Locanto.{% endblock %}
{% block keywords %}{{ ad.title|lower }}, {{ ad.city.name|lower }}, {{ ad.get_category_display|lower }}, kiaba, kiaba ci, bizi {{ ad.city.name|lower }}, jedolo ci, locanto ci, prostitution {{ ad.city.name|lower }}, escort {{ ad.city.name|lower }}, rencontres {{ ad.city.name|lower }}, côte d'ivoire{% endblock %}
{% block hreflang_fr_ci %}https://ci-kiaba.com/ads/{{ ad.slug }}{% endblock %}
{% block hreflang_default %}https://ci-kiaba.com/ads/{{ ad.slug }}{% endblock %}
{% block canonical_url %}https://ci-kiaba.com/ads/{{ ad.slug }}{% endblock %}
{% block structured_data %}
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "Person",
  "name": "{{ ad.title|escapejs }}",
  "description": "{{ ad.description_sanitized|truncatewords:50|escapejs }}",
  "url": "https://ci-kiaba.com/ads/{{ ad.slug }}",
  "address": {
    "@type": "PostalAddress",
    "addressLocality": "{{ ad.city.name }}",
    "addressCountry": "CI"
  }
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position": 1,
      "name": "Accueil",
      "item": "https://ci-kiaba.com"
    },
    {
      "@type": "ListItem",
      "position": 2,
      "name": "Annonces",
      "item": "https://ci-kiaba.com/ads"
    },
    {
      "@type": "ListItem",
      "position": 3,
      "name": "{{ ad.city.name }}",
      "item": "https://ci-kiaba.com/ads?city={{ ad.city.slug }}"
    },
    {
      "@type": "ListItem",
      "position": 4,
      "name": "{{ ad.title|escapejs }}",
      "item": "https://ci-kiaba.com/ads/{{ ad.slug }}"
    }
  ]
}
</script>
{% endblock %}

{% block breadcrumbs %}
<!-- Breadcrumbs with Schema.org -->
<nav class="mb-4 text-sm text-gray-600" aria-label="Breadcrumb">
  <ol class="flex items-center space-x-2 flex-wrap" itemscope itemtype="https://schema.org/BreadcrumbList">
    <li itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem">
      <a href="/" class="hover:text-gray-900" itemprop="item">
        <span itemprop="name">Accueil</span>
      </a>
      <meta itemprop="position" content="1" />
    </li>
    <li class="text-gray-400">/</li>
    <li itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem">
      <a href="/ads" class="hover:text-gray-900" itemprop="item">
        <span itemprop="name">Annonces</span>
      </a>
      <meta itemprop="position" content="2" />
    </li>
    <li class="text-gray-400">/</li>
    <li itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem">
      <a href="/ads?city={{ ad.city.slug }}" class="hover:text-gray-900" itemprop="item">
        <span itemprop="name">{{ ad.city.name }}</span>
      </a>
      <meta itemprop="position" content="3" />
    </li>
    <li class="text-gray-400">/</li>
    <li itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem">
      <span itemprop="name" class="text-gray-900 font-medium">{{ ad.title|truncatewords:5 }}</span>
      <meta itemprop="position" content="4" />
    </li>
  </ol>
</nav>
{% endblock %}


{% block content %}
<div class="flex flex-col lg:flex-row gap-6">
  <!-- Contenu principal -->
  <div class="flex-1">
<article class="bg-white border rounded-xl p-4 md:p-6 shadow-sm">
  <header class="mb-4 md:mb-6">
    <h1 class="text-2xl md:text-3xl font-bold text-gray-900 mb-2">{{ ad.title }} - {{ ad.get_category_display }} à {{ ad.city.name }}, Côte d'Ivoire</h1>
    <div class="flex flex-wrap items-center gap-2 text-sm text-gray-600 mb-3">
      <span class="bg-blue-100 text-blue-800 px-2 py-1 rounded-full">{{ ad.get_category_display }}</span>
      <span class="bg-gray-100 text-gray-700 px-2 py-1 rounded-full">{{ ad.city.name }}</span>
      <span class="text-gray-500">Publié le {{ ad.created_at|date:"d/m/Y à H:i" }}</span>
    </div>
    <div class="text-sm text-gray-600">
      Par <a class="underline text-blue-700 hover:text-blue-800 font-medium" href="/ads?provider={{ ad.user.id }}">{% if ad.user.profile %}{{ ad.user.profile.display_name|default:ad.user.username }}{% else %}{{ ad.user.username }}{% endif %}</a>
    </div>
  </header>

  <!-- Carousel principal -->
  <section class="relative rounded-lg overflow-hidden border bg-gray-50">
    <div class="w-full bg-gray-100 flex justify-center">
      {% if ad.media.all|length > 0 %}
        {% with first=ad.media.all.0 %}
          <img id="mainImage" src="{{ first.image.url }}" alt="{{ ad.title }} - {{ ad.get_category_display }} à {{ ad.city.name }}, Côte d'Ivoire | KIABA CI - Alternative Bizi Jedolo Locanto" class="max-w-full max-h-96 md:max-h-[500px] object-contain" loading="eager" width="800" height="600">
        {% endwith %}
      {% else %}
        <div class="w-full h-56 md:h-80 flex items-center justify-center text-gray-400">Aucune photo</div>
      {% endif %}
    </div>
    {% if ad.media.all|length > 1 %}
      <button type="button" id="btnPrev" class="absolute left-2 top-1/2 -translate-y-1/2 bg-white bg-opacity-80 hover:bg-opacity-100 text-gray-900 rounded-full w-9 h-9 flex items-center justify-center shadow" aria-label="Précédent">‹</button>
      <button type="button" id="btnNext" class="absolute right-2 top-1/2 -translate-y-1/2 bg-white bg-opacity-80 hover:bg-opacity-100 text-gray-900 rounded-full w-9 h-9 flex items-center justify-center shadow" aria-label="Suivant">›</button>
    {% endif %}
  </section>

  {% if ad.media.all|length > 1 %}
  <!-- Miniatures -->
  <section class="mt-2 md:mt-3 flex gap-2 overflow-x-auto">
    {% for m in ad.media.all %}
      <img data-idx="{{ forloop.counter0 }}" src="{{ m.image.url }}" alt="{{ ad.title }} - Photo {{ forloop.counter }}" class="thumb w-16 h-16 md:w-20 md:h-20 object-cover rounded-md border cursor-pointer hover:ring-2 hover:ring-blue-500 flex-shrink-0" loading="lazy" width="80" height="80">
    {% endfor %}
  </section>
  {% endif %}

  <!-- Sous-catégories -->
  {% if ad.subcategories %}
  <section class="mt-4">
    <h3 class="text-sm font-semibold text-gray-900 mb-2">Services proposés</h3>
    <div class="flex flex-wrap gap-2">
      {% for tag in ad.subcategories %}
        <span class="px-3 py-1 rounded-full bg-sky-50 text-sky-700 border border-sky-100 text-sm font-medium">{{ tag }}</span>
      {% endfor %}
    </div>
  </section>
  {% endif %}

  <!-- Description -->
  <section class="prose max-w-none mt-6 text-gray-800">
    <h2 class="text-lg font-semibold text-gray-900 mb-3">Description</h2>
    <div class="text-gray-700 leading-relaxed">
      {{ ad.description_sanitized|linebreaksbr }}
    </div>
    <p class="text-sm text-gray-500 mt-4">
      <strong>KIABA CI</strong> - Site de rencontres et petites annonces adultes en Côte d'Ivoire. Alternative locale à <strong>Bizi</strong>, <strong>Jedolo CI</strong> et <strong>Locanto CI</strong>. 
      Trouvez des services de <strong>prostitution</strong>, d'<strong>escort</strong> et de <strong>rencontres</strong> à {{ ad.city.name }} et dans toute la Côte d'Ivoire.
    </p>
  </section>

  <!-- Contact -->
  <section class="mt-4">
    <h2 class="text-sm font-semibold text-gray-900 mb-2">Contacter le prestataire</h2>
    <div class="flex flex-wrap gap-2">
      {% if ad.user.profile %}
        {% with prefs=ad.user.profile.contact_prefs %}
          {% if prefs %}
            {% if 'whatsapp' in prefs and ad.user.profile.whatsapp_e164 %}
              {% with msg="Bonjour, je viens de KIABA: "|add:ad.title %}
                <a class="inline-flex items-center bg-green-600 text-white px-3 py-2 rounded-lg shadow text-sm" href="https://wa.me/{{ ad.user.profile.whatsapp_e164|slice:'1:' }}?text={{ msg|urlencode }}" rel="nofollow noopener" target="_blank">WhatsApp</a>
              {% endwith %}
            {% endif %}
            {% if 'sms' in prefs and ad.user.phone_e164 %}
              <a class="inline-flex items-center bg-blue-600 text-white px-3 py-2 rounded-lg shadow text-sm" href="sms:{{ ad.user.phone_e164 }}" rel="nofollow">SMS</a>
            {% endif %}
            {% if 'call' in prefs and ad.user.phone_e164 %}
              <a class="inline-flex items-center bg-gray-900 text-white px-3 py-2 rounded-lg shadow text-sm" href="tel:{{ ad.user.phone_e164 }}" rel="nofollow">Appel</a>
            {% endif %}
          {% else %}
            {% if ad.user.profile.whatsapp_e164 %}
              {% with msg="Bonjour, je viens de KIABA: "|add:ad.title %}
                <a class="inline-flex items-center bg-green-600 text-white px-3 py-2 rounded-lg shadow text-sm" href="https://wa.me/{{ ad.user.profile.whatsapp_e164|slice:'1:' }}?text={{ msg|urlencode }}" rel="nofollow noopener" target="_blank">WhatsApp</a>
              {% endwith %}
            {% endif %}
            {% if ad.user.phone_e164 %}
              <a class="inline-flex items-center bg-blue-600 text-white px-3 py-2 rounded-lg shadow text-sm" href="sms:{{ ad.user.phone_e164 }}" rel="nofollow">SMS</a>
              <a class="inline-flex items-center bg-gray-900 text-white px-3 py-2 rounded-lg shadow text-sm" href="tel:{{ ad.user.phone_e164 }}" rel="nofollow">Appel</a>
            {% endif %}
          {% endif %}
        {% endwith %}
      {% else %}
        {% if ad.user.phone_e164 %}
          <a class="inline-flex items-center bg-blue-600 text-white px-3 py-2 rounded-lg shadow text-sm" href="sms:{{ ad.user.phone_e164 }}" rel="nofollow">SMS</a>
          <a class="inline-flex items-center bg-gray-900 text-white px-3 py-2 rounded-lg shadow text-sm" href="tel:{{ ad.user.phone_e164 }}" rel="nofollow">Appel</a>
        {% endif %}
      {% endif %}
    </div>
    {# Affichage explicite des numéros saisis #}
    <div class="mt-3 text-sm text-gray-700 space-y-1">
      {% if ad.user.phone_e164 %}
        <p>Numéro 1 : <span class="font-medium">{{ ad.user.phone_e164 }}</span></p>
      {% endif %}
      {% if ad.user.profile and ad.user.profile.whatsapp_e164 and ad.user.profile.whatsapp_e164 != ad.user.phone_e164 %}
        <p>Numéro 2 : <span class="font-medium">{{ ad.user.profile.whatsapp_e164 }}</span></p>
      {% endif %}
    </div>
  </section>

  <!-- Annonces similaires -->
  {% if similar_ads %}
    <section class="mt-16 pt-8 border-t border-gray-200">
      <h2 class="text-2xl font-bold text-gray-900 mb-8">Annonces similaires</h2>
      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
        {% for similar_ad in similar_ads %}
          <a href="/ads/{{ similar_ad.slug }}/" class="group block bg-white rounded-xl border border-gray-200 overflow-hidden shadow-sm hover:shadow-lg hover:border-gray-300 transition-all duration-200 h-40">
            <div class="flex h-full">
              <div class="w-40 flex-shrink-0 bg-slate-100">
                {% if similar_ad.media.count %}
                  <img src="{{ similar_ad.media.first.image.url }}" alt="{{ similar_ad.title }} - {{ similar_ad.get_category_display }} à {{ similar_ad.city.name }}, Côte d'Ivoire | KIABA CI" class="w-full h-full object-cover group-hover:scale-105 transition-transform duration-200" loading="lazy" width="160" height="160">
                {% else %}
                  <div class="w-full h-full bg-slate-200 flex items-center justify-center">
                    <span class="text-slate-400 text-xs">Photo</span>
                  </div>
                {% endif %}
              </div>
              <div class="flex-1 p-3 flex flex-col justify-between min-w-0 overflow-hidden">
                <div class="min-w-0 flex-1">
                  <div class="font-semibold text-gray-900 line-clamp-2 group-hover:text-blue-600 transition-colors mb-1">{{ similar_ad.title }}</div>
                  <div class="text-xs text-gray-600 mb-1 font-medium">{{ similar_ad.get_category_display }}</div>
                  <div class="text-xs text-gray-500 mb-1">{{ similar_ad.city.name }}</div>
                </div>
                <div class="flex justify-between items-end mt-1">
                  <div class="text-xs text-gray-700 font-semibold bg-gray-100 px-2 py-1 rounded">
                    {{ similar_ad.created_at|date:"d/m/Y" }}
                  </div>
                  <div class="flex flex-wrap gap-1">
                    {% for tag in similar_ad.subcategories|slice:":2" %}
                      <span class="px-2 py-1 rounded-full bg-blue-50 text-blue-700 border border-blue-100 text-xs font-medium truncate max-w-[85px] block" title="{{ tag }}">{{ tag }}</span>
                    {% endfor %}
                  </div>
                </div>
              </div>
            </div>
          </a>
        {% endfor %}
      </div>
    </section>
  {% endif %}
</article>
  </div>

  <!-- Sidebar (Desktop uniquement) -->
  <aside class="hidden lg:block w-80 flex-shrink-0">
    <div class="sticky top-20">
      <!-- Espace pour contenu supplémentaire -->
      <div class="mt-6 p-4 bg-blue-50 rounded-lg border border-blue-200">
        <h3 class="font-semibold text-gray-900 mb-2">Publier une annonce</h3>
        <p class="text-sm text-gray-600 mb-3">C'est gratuit et rapide !</p>
        <a href="/post" class="inline-block bg-blue-600 text-white px-4 py-2 rounded-lg text-sm font-medium hover:bg-blue-700 transition">
          Publier maintenant
        </a>
      </div>
    </div>
  </aside>
</div>
{% endblock %}

{% block extra_js %}
<script>
(function(){
  const images = [
    {% for m in ad.media.all %}"{{ m.image.url }}"{% if not forloop.last %},{% endif %}{% endfor %}
  ];
  if (!images.length) return;
  let idx = 0;
  const main = document.getElementById('mainImage');
  function show(i){
    idx = (i + images.length) % images.length;
    if (main) main.src = images[idx];
    document.querySelectorAll('.thumb').forEach((el)=>{
      const active = Number(el.getAttribute('data-idx')) === idx;
      el.classList.toggle('ring-2', active);
      el.classList.toggle('ring-blue-500', active);
    });
  }
  const prev = document.getElementById('btnPrev');
  const next = document.getElementById('btnNext');
  if (prev) prev.addEventListener('click', ()=>show(idx-1));
  if (next) next.addEventListener('click', ()=>show(idx+1));
  document.querySelectorAll('.thumb').forEach((el)=>{
    el.addEventListener('click', ()=>{
      const i = Number(el.getAttribute('data-idx'))||0;
      show(i);
    });
  });
  show(0);
})();
</script>
{% endblock %}


